<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main class="admin-container">
    <div class="breadcrumb">
      <a href="/admin/dashboard">‚Üê Back to Dashboard</a>
    </div>

    <h2>Ticket #<%= ticket.id %>: <%= ticket.title %></h2>
    <%- include('../partials/flash') %>

    <div class="ticket-detail-grid">
      <div class="ticket-info-card">
        <h3>Ticket Information</h3>
        <div class="info-row">
          <span class="info-label">Status:</span>
          <span class="badge badge-<%= ticket.status %>"><%= ticket.status.replace('_', ' ') %></span>
        </div>
        <div class="info-row">
          <span class="info-label">Priority:</span>
          <span class="badge badge-priority-<%= ticket.priority %>"><%= ticket.priority %></span>
        </div>
        <div class="info-row">
          <span class="info-label">Reporter:</span>
          <span><%= ticket.reporter_name %></span>
        </div>
        <div class="info-row">
          <span class="info-label">Email:</span>
          <span><a href="mailto:<%= ticket.reporter_email %>"><%= ticket.reporter_email %></a></span>
        </div>
        <% if (ticket.reporter_phone) { %>
          <div class="info-row">
            <span class="info-label">Phone:</span>
            <span><a href="tel:<%= ticket.reporter_phone %>"><%= ticket.reporter_phone %></a></span>
          </div>
        <% } %>
        <div class="info-row">
          <span class="info-label">Created:</span>
          <span><%= new Date(ticket.created_at).toLocaleString() %></span>
        </div>
        <div class="info-row">
          <span class="info-label">Last Updated:</span>
          <span><%= new Date(ticket.updated_at).toLocaleString() %></span>
        </div>
      </div>

      <div class="ticket-actions-card">
        <h3>Update Ticket</h3>
        <form action="/admin/tickets/<%= ticket.id %>/update" method="POST">
          <div class="form-group">
            <label for="status">Status</label>
            <select name="status" id="status">
              <option value="open" <%= ticket.status === 'open' ? 'selected' : '' %>>Open</option>
              <option value="in_progress" <%= ticket.status === 'in_progress' ? 'selected' : '' %>>In Progress</option>
              <option value="closed" <%= ticket.status === 'closed' ? 'selected' : '' %>>Closed</option>
            </select>
          </div>

          <div class="form-group">
            <label for="priority">Priority</label>
            <select name="priority" id="priority">
              <option value="low" <%= ticket.priority === 'low' ? 'selected' : '' %>>Low</option>
              <option value="medium" <%= ticket.priority === 'medium' ? 'selected' : '' %>>Medium</option>
              <option value="high" <%= ticket.priority === 'high' ? 'selected' : '' %>>High</option>
              <option value="critical" <%= ticket.priority === 'critical' ? 'selected' : '' %>>Critical</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary">Update Ticket</button>
        </form>
      </div>
    </div>

    <div class="ticket-description-card">
      <h3>Description</h3>
      <p class="ticket-description"><%= ticket.description %></p>
    </div>

    <div class="comments-section">
      <h3>Comments (<%= comments.length %>)</h3>

      <% if (comments.length > 0) { %>
        <div class="comments-list">
          <% comments.forEach(comment => { %>
            <div class="comment <%= comment.is_internal ? 'comment-internal' : '' %>">
              <div class="comment-header">
                <strong><%= comment.username %></strong>
                <span class="comment-date"><%= new Date(comment.created_at).toLocaleString() %></span>
                <% if (comment.is_internal) { %>
                  <span class="badge badge-internal">Internal</span>
                <% } %>
              </div>
              <div class="comment-body">
                <%= comment.content %>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <p class="no-comments">No comments yet. Be the first to add one!</p>
      <% } %>

      <div class="add-comment-card">
        <h4>Add Comment</h4>
        <form action="/admin/tickets/<%= ticket.id %>/comments" method="POST">
          <div class="form-group">
            <textarea name="content" id="content" rows="4" placeholder="Write your comment here..." required></textarea>
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" name="is_internal" value="true">
              Internal comment (not visible to client)
            </label>
          </div>
          <button type="submit" class="btn btn-primary">Add Comment</button>
        </form>
      </div>
    </div>
  </main>

  <%- include('../partials/footer') %>
</body>
</html>
