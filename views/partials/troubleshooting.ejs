<div class="troubleshooting-panel mt-4">
  <div class="card border-info">
    <div class="card-header bg-info text-white">
      <h6 class="card-title mb-0">
        <i class="bi bi-tools me-2"></i>
        Troubleshooting & Support
      </h6>
    </div>
    <div class="card-body">
      <!-- Error Reference -->
      <div class="alert alert-light border">
        <strong>Error Reference:</strong> <code><%= correlationId %></code>
        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('<%= correlationId %>')">
          <i class="bi bi-clipboard"></i> Copy
        </button>
        <small class="text-muted d-block mt-1">Use this ID when reporting this error</small>
      </div>

      <!-- Contextual Help Based on Error Type -->
      <% if (status === 404) { %>
        <div class="troubleshooting-section">
          <h6><i class="bi bi-search me-2"></i>Common causes for 404 errors:</h6>
          <ul class="list-unstyled">
            <li><i class="bi bi-dot text-primary me-2"></i>The page URL might be incorrect or outdated</li>
            <li><i class="bi bi-dot text-primary me-2"></i>The page may have been moved or deleted</li>
            <li><i class="bi bi-dot text-primary me-2"></i>You might need different permissions to access this page</li>
          </ul>
          <div class="mt-3">
            <strong>What you can try:</strong>
            <ul>
              <li>Check the URL for typos</li>
              <li>Use the navigation menu to find what you're looking for</li>
              <li>Go back to the previous page and try again</li>
            </ul>
          </div>
        </div>
      <% } else if (status === 403) { %>
        <div class="troubleshooting-section">
          <h6><i class="bi bi-shield-lock me-2"></i>Access denied - possible reasons:</h6>
          <ul class="list-unstyled">
            <li><i class="bi bi-dot text-warning me-2"></i>You need to log in to access this page</li>
            <li><i class="bi bi-dot text-warning me-2"></i>Your account doesn't have permission for this action</li>
            <li><i class="bi bi-dot text-warning me-2"></i>The page requires special access rights</li>
          </ul>
          <div class="mt-3">
            <strong>What you can try:</strong>
            <ul>
              <li>Log in with appropriate credentials</li>
              <li>Contact your administrator for access</li>
              <li>Check if you have the right role/permissions</li>
            </ul>
          </div>
        </div>
      <% } else if (status === 500) { %>
        <div class="troubleshooting-section">
          <h6><i class="bi bi-exclamation-triangle me-2"></i>Server error - what this means:</h6>
          <p class="text-muted">Something went wrong on our end. This is usually temporary.</p>
          <div class="mt-3">
            <strong>What you can try:</strong>
            <ul>
              <li>Wait a few minutes and try again</li>
              <li>Refresh the page</li>
              <li>Clear your browser cache</li>
              <li>Report this error if it persists</li>
            </ul>
          </div>
        </div>
      <% } %>

      <!-- Development Debug Info -->
      <% if (isDevelopment && stackTrace) { %>
        <div class="mt-4">
          <button class="btn btn-outline-danger btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#debugInfo">
            <i class="bi bi-bug me-1"></i>Show Debug Info (Development Only)
          </button>
          <div class="collapse mt-2" id="debugInfo">
            <div class="alert alert-danger">
              <h6>Stack Trace:</h6>
              <pre class="mb-0" style="font-size: 0.75rem;"><%= stackTrace %></pre>
            </div>
          </div>
        </div>
      <% } %>

      <!-- Error Reporting -->
      <div class="mt-4 pt-3 border-top">
        <h6><i class="bi bi-flag me-2"></i>Report This Error</h6>
        <p class="text-muted small">Help us improve by reporting this error. Include the error reference ID above.</p>
        <button class="btn btn-outline-primary btn-sm" onclick="reportError('<%= correlationId %>', '<%= errorCategory %>')">
          <i class="bi bi-envelope me-1"></i>Report Error
        </button>
      </div>

      <!-- Quick Actions -->
      <div class="mt-3 pt-3 border-top">
        <div class="row g-2">
          <div class="col-auto">
            <button class="btn btn-outline-secondary btn-sm" onclick="window.history.back()">
              <i class="bi bi-arrow-left me-1"></i>Go Back
            </button>
          </div>
          <div class="col-auto">
            <button class="btn btn-outline-secondary btn-sm" onclick="window.location.reload()">
              <i class="bi bi-arrow-clockwise me-1"></i>Refresh Page
            </button>
          </div>
          <div class="col-auto">
            <a href="/" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-house me-1"></i>Home
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Copy error ID to clipboard
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    // Show temporary success message
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
    btn.classList.remove('btn-outline-secondary');
    btn.classList.add('btn-success');
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-secondary');
    }, 2000);
  }).catch(function(err) {
    console.error('Failed to copy: ', err);
  });
}

// Report error functionality
function reportError(correlationId, category) {
  // Show a modal or form for user input
  const userDescription = prompt(
    'Please describe what you were doing when this error occurred (optional):',
    ''
  );

  if (userDescription === null) {
    // User cancelled
    return;
  }

  // Submit the error report via AJAX
  fetch('/api/errors/report', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      // Include CSRF token if available
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
    },
    body: JSON.stringify({
      correlationId: correlationId,
      category: category,
      userDescription: userDescription,
      additionalData: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString(),
        viewport: {
          width: window.innerWidth,
          height: window.innerHeight
        }
      }
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Thank you! Your error report has been submitted. Reference ID: ' + correlationId);
    } else {
      alert('Failed to submit error report. You can still email support with the reference ID: ' + correlationId);
      // Fallback to mailto
      fallbackEmailReport(correlationId, category, userDescription);
    }
  })
  .catch(error => {
    console.error('Error submitting report:', error);
    alert('Failed to submit error report. You can still email support with the reference ID: ' + correlationId);
    // Fallback to mailto
    fallbackEmailReport(correlationId, category, userDescription);
  });
}

function fallbackEmailReport(correlationId, category, userDescription) {
  const subject = `Error Report: ${category} (${correlationId})`;
  const body = `Error Reference: ${correlationId}
Error Category: ${category}
URL: ${window.location.href}
Browser: ${navigator.userAgent}
Timestamp: ${new Date().toISOString()}

User Description:
${userDescription || 'No description provided'}

---
This error report was submitted from the error page.`;

  const mailtoLink = `mailto:support@yourcompany.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailtoLink;
}
</script>