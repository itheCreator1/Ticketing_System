<div class="mt-6">
  <div class="card border-blue-500">
    <div class="bg-blue-500 text-white px-4 py-3 rounded-t-lg">
      <h6 class="font-medium mb-0">
        <i class="bi bi-tools mr-2"></i>
        Troubleshooting & Support
      </h6>
    </div>
    <div class="card-body">
      <!-- Error Reference -->
      <div class="alert alert-light border mb-4">
        <strong>Error Reference:</strong> <code class="text-sm"><%= correlationId %></code>
        <button class="btn btn-sm btn-outline-secondary ml-2" onclick="copyToClipboard('<%= correlationId %>')">
          <i class="bi bi-clipboard"></i> Copy
        </button>
        <small class="block text-gray-600 mt-1">Use this ID when reporting this error</small>
      </div>

      <!-- Contextual Help Based on Error Type -->
      <% if (status === 404) { %>
        <div class="mb-4">
          <h6 class="font-medium mb-3"><i class="bi bi-search mr-2"></i>Common causes for 404 errors:</h6>
          <ul class="list-none space-y-2">
            <li><i class="bi bi-dot text-blue-600 mr-2"></i>The page URL might be incorrect or outdated</li>
            <li><i class="bi bi-dot text-blue-600 mr-2"></i>The page may have been moved or deleted</li>
            <li><i class="bi bi-dot text-blue-600 mr-2"></i>You might need different permissions to access this page</li>
          </ul>
          <div class="mt-4">
            <strong class="block mb-2">What you can try:</strong>
            <ul class="list-disc ml-6 space-y-1">
              <li>Check the URL for typos</li>
              <li>Use the navigation menu to find what you're looking for</li>
              <li>Go back to the previous page and try again</li>
            </ul>
          </div>
        </div>
      <% } else if (status === 403) { %>
        <div class="mb-4">
          <h6 class="font-medium mb-3"><i class="bi bi-shield-lock mr-2"></i>Access denied - possible reasons:</h6>
          <ul class="list-none space-y-2">
            <li><i class="bi bi-dot text-yellow-600 mr-2"></i>You need to log in to access this page</li>
            <li><i class="bi bi-dot text-yellow-600 mr-2"></i>Your account doesn't have permission for this action</li>
            <li><i class="bi bi-dot text-yellow-600 mr-2"></i>The page requires special access rights</li>
          </ul>
          <div class="mt-4">
            <strong class="block mb-2">What you can try:</strong>
            <ul class="list-disc ml-6 space-y-1">
              <li>Log in with appropriate credentials</li>
              <li>Contact your administrator for access</li>
              <li>Check if you have the right role/permissions</li>
            </ul>
          </div>
        </div>
      <% } else if (status === 500) { %>
        <div class="mb-4">
          <h6 class="font-medium mb-3"><i class="bi bi-exclamation-triangle mr-2"></i>Server error - what this means:</h6>
          <p class="text-gray-600">Something went wrong on our end. This is usually temporary.</p>
          <div class="mt-4">
            <strong class="block mb-2">What you can try:</strong>
            <ul class="list-disc ml-6 space-y-1">
              <li>Wait a few minutes and try again</li>
              <li>Refresh the page</li>
              <li>Clear your browser cache</li>
              <li>Report this error if it persists</li>
            </ul>
          </div>
        </div>
      <% } %>

      <!-- Development Debug Info -->
      <% if (isDevelopment && stackTrace) { %>
        <div class="mt-6">
          <button class="btn btn-outline-danger btn-sm" type="button" onclick="toggleDebugInfo()">
            <i class="bi bi-bug mr-1"></i>Show Debug Info (Development Only)
          </button>
          <div class="hidden mt-3" id="debugInfo">
            <div class="alert alert-danger">
              <h6 class="font-medium mb-2">Stack Trace:</h6>
              <pre class="text-xs mb-0 overflow-x-auto"><%= stackTrace %></pre>
            </div>
          </div>
        </div>
      <% } %>

      <!-- Error Reporting -->
      <div class="mt-6 pt-4 border-t border-gray-200">
        <h6 class="font-medium mb-2"><i class="bi bi-flag mr-2"></i>Report This Error</h6>
        <p class="text-gray-600 text-sm mb-3">Help us improve by reporting this error. Include the error reference ID above.</p>
        <button class="btn btn-outline-primary btn-sm" onclick="reportError('<%= correlationId %>', '<%= errorCategory %>')">
          <i class="bi bi-envelope mr-1"></i>Report Error
        </button>
      </div>

      <!-- Quick Actions -->
      <div class="mt-4 pt-4 border-t border-gray-200">
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="window.history.back()">
            <i class="bi bi-arrow-left mr-1"></i>Go Back
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="window.location.reload()">
            <i class="bi bi-arrow-clockwise mr-1"></i>Refresh Page
          </button>
          <a href="/" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-house mr-1"></i>Home
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Toggle debug info
function toggleDebugInfo() {
  const debugInfo = document.getElementById('debugInfo');
  debugInfo.classList.toggle('hidden');
}

// Copy error ID to clipboard
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
    btn.classList.remove('btn-outline-secondary');
    btn.classList.add('btn-success');
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-secondary');
    }, 2000);
  }).catch(function(err) {
    console.error('Failed to copy: ', err);
  });
}

// Report error functionality
function reportError(correlationId, category) {
  const userDescription = prompt(
    'Please describe what you were doing when this error occurred (optional):',
    ''
  );

  if (userDescription === null) {
    return;
  }

  fetch('/api/errors/report', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
    },
    body: JSON.stringify({
      correlationId: correlationId,
      category: category,
      userDescription: userDescription,
      additionalData: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString(),
        viewport: {
          width: window.innerWidth,
          height: window.innerHeight
        }
      }
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Thank you! Your error report has been submitted. Reference ID: ' + correlationId);
    } else {
      alert('Failed to submit error report. You can still email support with the reference ID: ' + correlationId);
      fallbackEmailReport(correlationId, category, userDescription);
    }
  })
  .catch(error => {
    console.error('Error submitting report:', error);
    alert('Failed to submit error report. You can still email support with the reference ID: ' + correlationId);
    fallbackEmailReport(correlationId, category, userDescription);
  });
}

function fallbackEmailReport(correlationId, category, userDescription) {
  const subject = `Error Report: ${category} (${correlationId})`;
  const body = `Error Reference: ${correlationId}
Error Category: ${category}
URL: ${window.location.href}
Browser: ${navigator.userAgent}
Timestamp: ${new Date().toISOString()}

User Description:
${userDescription || 'No description provided'}

---
This error report was submitted from the error page.`;

  const mailtoLink = `mailto:support@yourcompany.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailtoLink;
}
</script>
